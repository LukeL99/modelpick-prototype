---
phase: 01-configure-benchmark
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/(marketing)/layout.tsx
  - src/app/(marketing)/page.tsx
  - src/app/(app)/layout.tsx
  - src/app/(app)/dashboard/page.tsx
  - src/app/auth/login/page.tsx
  - src/app/auth/signup/page.tsx
  - src/app/auth/callback/route.ts
  - src/app/auth/confirm/route.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/middleware.ts
  - src/middleware.ts
  - src/components/auth/login-form.tsx
  - src/components/auth/signup-form.tsx
  - src/components/auth/social-buttons.tsx
  - src/components/dashboard/report-list.tsx
  - src/components/dashboard/report-card.tsx
  - src/components/dashboard/empty-state.tsx
  - src/components/ui/button.tsx
  - src/components/ui/card.tsx
  - src/types/database.ts
  - src/types/wizard.ts
  - src/types/benchmark.ts
  - src/lib/config/models.ts
  - src/lib/config/constants.ts
  - supabase/migrations/001_initial_schema.sql
  - .env.local.example
  - next.config.ts
  - tailwind.css
  - package.json
autonomous: true
user_setup:
  - service: supabase
    why: "Auth + Database + Storage backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Create Supabase project"
        location: "https://supabase.com/dashboard -> New project"
      - task: "Enable Google OAuth provider"
        location: "Supabase Dashboard -> Auth -> Providers -> Google (requires Google Cloud Console OAuth credentials)"
      - task: "Enable GitHub OAuth provider"
        location: "Supabase Dashboard -> Auth -> Providers -> GitHub (requires GitHub OAuth App)"
      - task: "Add redirect URLs"
        location: "Supabase Dashboard -> Auth -> URL Configuration -> Redirect URLs: add http://localhost:3000/auth/callback"
      - task: "Create benchmark-images storage bucket"
        location: "Supabase Dashboard -> Storage -> New bucket -> name: benchmark-images, private"
      - task: "Run database migration"
        location: "Copy supabase/migrations/001_initial_schema.sql and run in Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "User can create an account with email/password and is redirected to dashboard"
    - "User can sign in with Google OAuth and is redirected to dashboard"
    - "User can sign in with GitHub OAuth and is redirected to dashboard"
    - "User can request a magic link via email"
    - "User session persists across browser refresh (middleware refreshes token)"
    - "Authenticated user sees dashboard with empty state and CTA to run first benchmark"
    - "Unauthenticated user visiting /dashboard is redirected to /auth/login"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Auth session refresh on every request"
      contains: "updateSession"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "src/app/auth/callback/route.ts"
      provides: "OAuth + magic link PKCE exchange"
      exports: ["GET"]
    - path: "src/app/(app)/dashboard/page.tsx"
      provides: "Dashboard page with report list or empty state"
      min_lines: 20
    - path: "supabase/migrations/001_initial_schema.sql"
      provides: "Database schema for drafts and reports"
      contains: "benchmark_drafts"
    - path: "src/types/wizard.ts"
      provides: "Type definitions for wizard state"
      contains: "WizardConfig"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "import.*updateSession.*middleware"
    - from: "src/app/auth/callback/route.ts"
      to: "@supabase/ssr"
      via: "exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
    - from: "src/app/(app)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "Server client getUser check"
      pattern: "getUser"
---

<objective>
Set up the Next.js 16 project from scratch with Supabase Auth (email/password, Google, GitHub, magic link), middleware-based session refresh, database schema, and an authenticated dashboard with empty state.

Purpose: Establish the project foundation that all subsequent plans build on -- authentication, database schema, Supabase clients, route structure, and the dashboard as the primary logged-in experience.
Output: Working Next.js app with auth flow, protected dashboard route, database migration, and type definitions.
</objective>

<execution_context>
@/Users/lukelibraro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lukelibraro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-configure-benchmark/01-RESEARCH.md
@.planning/phases/01-configure-benchmark/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js project, install dependencies, configure Supabase, database schema, and middleware</name>
  <files>
    package.json
    next.config.ts
    tailwind.css
    .env.local.example
    src/app/layout.tsx
    src/app/(marketing)/layout.tsx
    src/app/(marketing)/page.tsx
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/middleware.ts
    src/middleware.ts
    src/types/database.ts
    src/types/wizard.ts
    src/types/benchmark.ts
    src/lib/config/models.ts
    src/lib/config/constants.ts
    supabase/migrations/001_initial_schema.sql
  </files>
  <action>
    **IMPORTANT: This is a FRESH Next.js build. The existing Vite/React prototype in this repo is reference only. Create the Next.js app in a NEW directory structure (`src/app/` App Router) alongside the existing `src/` prototype code. The prototype files will be cleaned up later.**

    1. **Initialize Next.js 16 project:**
       Run `npx create-next-app@latest . --typescript --tailwind --app --src-dir --turbopack` in a temporary directory, then copy the generated scaffold files into the repo root, OVERWRITING existing Vite config files (vite.config.ts, etc.) but preserving `.planning/` and `.git/`. The key files needed: `next.config.ts`, `postcss.config.mjs`, `tsconfig.json`, `package.json` (merge dependencies). Remove Vite-specific files: `vite.config.ts`, `index.html`, `src/main.tsx`, `src/App.tsx`.

    2. **Install all Phase 1 dependencies:**
       ```
       npm install @supabase/supabase-js @supabase/ssr zod nanoid lucide-react
       npm install @dnd-kit/react @dnd-kit/helpers react-dropzone @uiw/react-codemirror @codemirror/lang-json @uiw/codemirror-theme-vscode @jsonhero/schema-infer nuqs
       ```
       Remove old Vite/React Router dependencies: `react-router-dom`, `@vitejs/plugin-react`, `@tailwindcss/vite`, `recharts`, `vite`.

    3. **Configure Tailwind CSS v4 with dark-warm palette:**
       Create `src/app/globals.css` (or `tailwind.css` at root) with Tailwind v4 `@import "tailwindcss"` and `@theme` block defining the design system colors:
       - `--color-void: #0A0A0B` (background)
       - `--color-surface: #141415` (card background)
       - `--color-surface-raised: #1E1E20` (elevated surfaces)
       - `--color-surface-border: #2A2A2D` (borders)
       - `--color-ember: #F97316` (primary/orange)
       - `--color-ember-hover: #EA580C` (primary hover)
       - `--color-text-primary: #F5F5F5` (main text)
       - `--color-text-secondary: #A3A3A8` (secondary text)
       - `--color-text-muted: #6B6B70` (muted text)
       Font families: Inter for body, JetBrains Mono for code. Import via `next/font/google` in root layout.

    4. **Create root layout** (`src/app/layout.tsx`):
       - Import Inter and JetBrains Mono from `next/font/google`
       - Apply dark background (`bg-void text-text-primary`) to body
       - Set metadata: title "ModelPick", description about vision model benchmarking
       - Wrap children with `<NuqsAdapter>` from `nuqs/adapters/next/app` for URL state

    5. **Create marketing layout** (`src/app/(marketing)/layout.tsx`):
       - Simple layout with no auth check (public routes)
       - Minimal header with ModelPick logo/wordmark and "Sign In" link

    6. **Create placeholder landing page** (`src/app/(marketing)/page.tsx`):
       - Simple hero section: "Find the best vision model for your data" headline
       - CTA button linking to `/auth/signup`
       - Minimal -- will be fleshed out later. Just enough to have a working root route.

    7. **Create Supabase client helpers** (follow RESEARCH.md patterns EXACTLY):
       - `src/lib/supabase/client.ts`: `createClient()` using `createBrowserClient` from `@supabase/ssr`
       - `src/lib/supabase/server.ts`: async `createClient()` using `createServerClient` from `@supabase/ssr` with `cookies()` from `next/headers`
       - `src/lib/supabase/middleware.ts`: `updateSession()` function that creates server client, calls `getUser()` for token refresh, redirects unauthenticated users on `/(app)` routes to `/auth/login`

    8. **Create Next.js middleware** (`src/middleware.ts`):
       - Import and call `updateSession` from `src/lib/supabase/middleware`
       - Matcher config: exclude `_next/static`, `_next/image`, favicon, and image files

    9. **Create database migration** (`supabase/migrations/001_initial_schema.sql`):
       Use the EXACT schema from RESEARCH.md Pattern: Phase 1 Database Schema section. Includes:
       - `benchmark_drafts` table with separate JSONB columns for config_data, upload_data, schema_data
       - `reports` table with config_snapshot, share_token, status
       - RLS policies: owners can CRUD drafts, owners can read reports, anyone can read shared reports
       - Indexes on user_id, status, share_token, created_at

    10. **Create type definitions:**
        - `src/types/database.ts`: TypeScript types matching the DB schema (BenchmarkDraft, Report interfaces). Include Supabase Database type structure for typed queries.
        - `src/types/wizard.ts`: WizardConfig (priorities, strategy, sampleCount), WizardStep enum, Priority type (accuracy/speed/cost), Strategy type (quick-survey/deep-dive/balanced), ImageEntry type (path, publicUrl, expectedJson, jsonValid), SchemaConfig type.
        - `src/types/benchmark.ts`: Report type, BenchmarkConfig type, ModelInfo type matching the curated model list.

    11. **Create config files:**
        - `src/lib/config/models.ts`: Curated model lineup array with metadata per model: id (OpenRouter model ID), name (display name), provider, tier (premium/mid/budget), inputCostPer1k, outputCostPer1k, contextWindow, supportsVision: true. Include at least 20 models from the curated list. Add `PROVIDER_COLORS` and `TIER_COLORS` maps.
        - `src/lib/config/constants.ts`: MAX_IMAGES (10), MIN_IMAGES (1), MAX_FILE_SIZE_MB (10), ACCEPTED_IMAGE_TYPES, API_BUDGET_CEILING (7.00), REPORT_PRICE (14.99), DEFAULT_PRIORITIES, DEFAULT_STRATEGY, PRICES_AS_OF_DATE.

    12. **Create `.env.local.example`:**
        ```
        NEXT_PUBLIC_SUPABASE_URL=your-project-url
        NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
        NEXT_PUBLIC_SITE_URL=http://localhost:3000
        ```

    **Anti-patterns to AVOID:**
    - Do NOT use `getSession()` in server code -- always `getUser()`
    - Do NOT use `@supabase/auth-helpers-nextjs` -- it is deprecated, use `@supabase/ssr`
    - Do NOT create a single JSONB column for all wizard state -- use separate columns per step to avoid race conditions
    - Do NOT hardcode localhost in OAuth redirect URLs -- use `process.env.NEXT_PUBLIC_SITE_URL` or `window.location.origin`
  </action>
  <verify>
    1. `npm run build` succeeds with no TypeScript errors
    2. `npm run dev` starts the dev server and visiting http://localhost:3000 shows the landing page
    3. The `/auth/login` route loads (even without Supabase configured, the page renders)
    4. TypeScript types in `src/types/` compile without errors
    5. `supabase/migrations/001_initial_schema.sql` exists and contains valid SQL
  </verify>
  <done>
    Next.js 16 project builds and runs. Supabase clients, middleware, migration, type definitions, and config files all exist and compile. Root route shows a landing page. Auth routes exist (even if Supabase is not yet configured by the user).
  </done>
</task>

<task type="auto">
  <name>Task 2: Auth UI pages (login, signup, callback) and dashboard with empty state</name>
  <files>
    src/app/auth/login/page.tsx
    src/app/auth/signup/page.tsx
    src/app/auth/callback/route.ts
    src/app/auth/confirm/route.ts
    src/app/(app)/layout.tsx
    src/app/(app)/dashboard/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/signup-form.tsx
    src/components/auth/social-buttons.tsx
    src/components/dashboard/report-list.tsx
    src/components/dashboard/report-card.tsx
    src/components/dashboard/empty-state.tsx
    src/components/ui/button.tsx
    src/components/ui/card.tsx
  </files>
  <action>
    **Build the authentication UI and dashboard page. Follow the dark-warm palette (void background, ember accents, Inter font).**

    1. **Create shared UI components:**
       - `src/components/ui/button.tsx`: Reusable button with variants: `primary` (bg-ember text-white hover:bg-ember-hover), `secondary` (bg-surface-raised border-surface-border), `ghost` (transparent hover:bg-surface-raised). Sizes: `sm`, `md`, `lg`. Accept standard button props.
       - `src/components/ui/card.tsx`: Reusable card with `bg-surface border border-surface-border rounded-xl` base style. Accept className for composition.

    2. **Create social login buttons** (`src/components/auth/social-buttons.tsx`):
       - "use client" component
       - "Continue with Google" and "Continue with GitHub" buttons
       - Each calls `supabase.auth.signInWithOAuth({ provider, options: { redirectTo: \`${window.location.origin}/auth/callback\` } })`
       - Use the browser Supabase client from `src/lib/supabase/client.ts`
       - Show loading state while redirecting
       - Style: full-width buttons with provider icons (use lucide-react or inline SVGs for Google/GitHub logos)

    3. **Create login form** (`src/components/auth/login-form.tsx`):
       - "use client" component
       - Two modes: email/password login, and magic link
       - Email input + password input + "Sign In" button for email/password mode
       - "Send Magic Link" button that calls `supabase.auth.signInWithOtp({ email, options: { emailRedirectTo } })`
       - Toggle between modes: "Use magic link instead" / "Use password instead"
       - Show success message after magic link sent: "Check your email for a sign-in link"
       - Show error messages inline (e.g., "Invalid login credentials")
       - On successful email/password login, redirect to `/dashboard` using `router.push`
       - Link to signup: "Don't have an account? Sign up"

    4. **Create signup form** (`src/components/auth/signup-form.tsx`):
       - "use client" component
       - Email + password + confirm password fields
       - Call `supabase.auth.signUp({ email, password, options: { emailRedirectTo: \`${origin}/auth/callback\` } })`
       - Show confirmation message: "Check your email to confirm your account"
       - Show inline validation: password min 8 chars, passwords match
       - Link to login: "Already have an account? Sign in"

    5. **Create auth pages:**
       - `src/app/auth/login/page.tsx`: Server component that renders login-form + social-buttons. Centered card layout on void background. ModelPick wordmark at top.
       - `src/app/auth/signup/page.tsx`: Same layout with signup-form + social-buttons.
       - Both pages: Check if user is already authenticated via server client `getUser()`. If authenticated, redirect to `/dashboard`.

    6. **Create auth callback routes** (follow RESEARCH.md patterns EXACTLY):
       - `src/app/auth/callback/route.ts`: GET handler that exchanges `code` search param for session via `exchangeCodeForSession`. On success, redirect to `/dashboard` (or `next` param). On error, redirect to `/auth/login?error=auth_callback_failed`.
       - `src/app/auth/confirm/route.ts`: GET handler for email confirmation. Same PKCE exchange pattern. Redirect to `/dashboard` on success.

    7. **Create authenticated app layout** (`src/app/(app)/layout.tsx`):
       - Server component
       - Check auth via `getUser()` -- if no user, redirect to `/auth/login`
       - Simple top nav bar: ModelPick logo (links to /dashboard), user email display, "New Benchmark" button (links to /benchmark/new), "Sign Out" button
       - Sign out: Create a client component for the sign-out button that calls `supabase.auth.signOut()` and redirects to `/`
       - Body area renders `{children}`

    8. **Create dashboard page** (`src/app/(app)/dashboard/page.tsx`):
       - Server component that fetches user's reports from Supabase: `supabase.from('reports').select('*').eq('user_id', user.id).order('created_at', { ascending: false })`
       - If no reports: render `<EmptyState />`
       - If reports exist: render `<ReportList reports={reports} />`

    9. **Create dashboard components:**
       - `src/components/dashboard/empty-state.tsx`: Big centered CTA. Headline: "Run your first benchmark". Subtext: "Upload sample images, tell us what to extract, and we'll test 20+ vision models to find the best one for your use case." Big ember-colored button: "Start Benchmark" linking to `/benchmark/new`. Below: "See an example report" link (placeholder href for now -- links to # or a future example report).
       - `src/components/dashboard/report-card.tsx`: Card component showing report summary. Props: report object. Display: date (formatted), top model name, accuracy %, cost, number of models tested, status badge. Link to `/report/{id}` (non-functional in Phase 1 but structured correctly).
       - `src/components/dashboard/report-list.tsx`: Renders array of ReportCard components in a vertical list. Heading: "Your Reports" with count. Per user decision: simple chronological list, newest first, no search/filter/tags.

    **Design guidelines (Claude's discretion):**
    - Auth pages: Centered card (max-w-md) on void background, ModelPick wordmark above
    - Social buttons above the divider ("or"), then email/password form below
    - Inputs: bg-surface-raised border-surface-border rounded-lg, focus ring in ember
    - Error messages: text-red-400, shown inline below the relevant input
    - Loading states: Button shows spinner (Loader2 from lucide-react) and disables during async ops
    - Mobile: Stack layout works naturally with max-w-md centering

    **Anti-patterns to AVOID:**
    - Do NOT use `getSession()` in server components -- use `getUser()`
    - Do NOT skip the `try/catch` in server.ts `setAll` -- it is needed for Server Component read-only cookie context
    - Do NOT hardcode redirect URLs -- use `window.location.origin` or env var
  </action>
  <verify>
    1. `npm run build` succeeds
    2. Visiting `/auth/login` shows the login form with social buttons, email/password fields, and magic link option
    3. Visiting `/auth/signup` shows the signup form with social buttons
    4. Visiting `/dashboard` without auth redirects to `/auth/login`
    5. The empty state component renders with "Run your first benchmark" CTA
    6. TypeScript compiles with no errors in all auth and dashboard components
  </verify>
  <done>
    Auth UI complete: login page with email/password, social (Google/GitHub), and magic link. Signup page with email confirmation flow. OAuth callback route handles PKCE exchange. Dashboard page shows empty state for new users and report list for returning users. All protected routes redirect to login when unauthenticated. Session persists across refresh via middleware.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes with zero errors
2. Dev server starts and root route (`/`) shows landing page
3. `/auth/login` renders login form with all auth methods
4. `/auth/signup` renders signup form
5. `/dashboard` redirects to login when not authenticated
6. After Supabase is configured by user: full auth flow works (signup -> confirm email -> login -> dashboard)
7. Database migration SQL is valid and creates benchmark_drafts + reports tables with RLS
</verification>

<success_criteria>
- Next.js 16 App Router project with TypeScript, Tailwind CSS v4, and dark-warm palette is fully set up
- All Supabase client helpers (browser, server, middleware) are implemented following official patterns
- Auth supports email/password, Google OAuth, GitHub OAuth, and magic link
- Dashboard shows empty state with CTA for new users and chronological report list for returning users
- All Phase 1 type definitions and config files exist and compile
- Database migration covers benchmark_drafts and reports tables with proper RLS
</success_criteria>

<output>
After completion, create `.planning/phases/01-configure-benchmark/01-01-SUMMARY.md`
</output>
