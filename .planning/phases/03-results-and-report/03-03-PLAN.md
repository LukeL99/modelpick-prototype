---
phase: 03-results-and-report
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/report/[token]/page.tsx
  - src/components/report/report-header.tsx
  - src/components/report/recommendation-card.tsx
  - src/components/report/ranked-table.tsx
  - src/components/report/share-button.tsx
autonomous: true

must_haves:
  truths:
    - "Report page loads server-side via share_token (no auth required for shared reports)"
    - "Report shows a recommendation card with top model name, rationale, and savings callout"
    - "Report shows a ranked table sortable by accuracy, cost/run, median RT, P95 RT, and spread"
    - "Shareable link can be copied to clipboard"
    - "Report page returns 404 for invalid tokens or non-complete reports"
  artifacts:
    - path: "src/app/report/[token]/page.tsx"
      provides: "Public shareable report page (server component)"
      contains: "transformRunsToReport"
    - path: "src/components/report/report-header.tsx"
      provides: "Report title, metadata, share/export action buttons"
      exports: ["ReportHeader"]
    - path: "src/components/report/recommendation-card.tsx"
      provides: "Top recommendation with rationale and savings"
      exports: ["RecommendationCard"]
    - path: "src/components/report/ranked-table.tsx"
      provides: "Sortable results table (client component)"
      exports: ["RankedTable"]
    - path: "src/components/report/share-button.tsx"
      provides: "Copy shareable link button"
      exports: ["ShareButton"]
  key_links:
    - from: "src/app/report/[token]/page.tsx"
      to: "src/lib/report/aggregate.ts"
      via: "transformRunsToReport() for data preparation"
      pattern: "transformRunsToReport"
    - from: "src/app/report/[token]/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "Server client for share_token query"
      pattern: "createClient"
    - from: "src/components/report/ranked-table.tsx"
      to: "src/types/report.ts"
      via: "ModelSummary type for table rows"
      pattern: "ModelSummary"
---

<objective>
Create the shareable report page at `/report/[token]` as a server component that loads all data server-side, plus the core report UI: header with share button, recommendation card, and sortable ranked table.

Purpose: This is the primary report experience (RPT-01, RPT-02, RPT-11). The report page acts as the shell into which charts, error analysis, and PDF export will be added in Plan 04.

Output: Report server page, 4 component files (header, recommendation, ranked table, share button).
</objective>

<execution_context>
@/Users/lukelibraro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lukelibraro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-results-and-report/03-RESEARCH.md

# Data layer built in Plan 01
@src/types/report.ts
@src/lib/report/aggregate.ts
@src/lib/report/recommendation.ts

# Supabase server client for data loading
@src/lib/supabase/server.ts

# Database types
@src/types/database.ts
@src/types/benchmark.ts

# Model info
@src/lib/config/models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report server page and header/share components</name>
  <files>
    src/app/report/[token]/page.tsx
    src/components/report/report-header.tsx
    src/components/report/share-button.tsx
  </files>
  <action>
**Step A: Create `src/components/report/share-button.tsx`** (`"use client"` component):

- Props: `shareToken: string`
- On click: build full URL `${window.location.origin}/report/${shareToken}`, copy to clipboard via `navigator.clipboard.writeText()`, show "Copied!" state for 2 seconds via useState
- Render: Button with Share2 icon from lucide-react, text "Share" / "Copied!", styled with existing Button patterns (secondary variant: `bg-surface-raised border border-surface-border text-text-primary hover:bg-surface-border`)

**Step B: Create `src/components/report/report-header.tsx`** (server component, no "use client"):

- Props: `reportData: ReportData`, `shareToken: string`
- Render:
  - Title: "Benchmark Report" in text-3xl font-bold text-text-primary
  - Subtitle: "{modelCount} models tested across {imageCount} images" in text-text-secondary
  - Completion timestamp: "Completed {formatted date}" in text-text-muted text-sm
  - Action buttons row (flex, gap-3): `<ShareButton shareToken={shareToken} />` and a placeholder div with id="pdf-export-slot" for the PDF button (Plan 04 will add it)
- Use relative time or formatted date for completion timestamp

**Step C: Create `src/app/report/[token]/page.tsx`** (server component):

1. **Data loading:**
   - Create Supabase server client via `createClient()`
   - Query `reports` table: `.select("*").eq("share_token", token).single()`
   - If no report or report.status !== "complete", call `notFound()` from next/navigation
   - Query `benchmark_runs` table: `.select("*").eq("report_id", report.id).order("model_id")`
   - Call `transformRunsToReport(report, runs)` to get ReportData
   - Call `generateRationale(recommended, reportData.models, reportData.priorities)` for rationale text

2. **Next.js metadata:**
   - Export `generateMetadata()` that returns title "Benchmark Report | ModelBlitz" and description

3. **Layout:**
   ```
   <div id="report-content" className="max-w-6xl mx-auto px-6 py-8 space-y-8">
     <ReportHeader reportData={reportData} shareToken={token} />
     <RecommendationCard ... />
     <RankedTable models={reportData.models} />
     {/* Charts section - Plan 04 will add components here */}
     {/* Error analysis section - Plan 04 will add components here */}
     {/* Cost calculator section - Plan 04 will add components here */}
   </div>
   ```
   The `id="report-content"` is needed for PDF export (html2pdf.js targets this element).

4. **Route structure:** This is a PUBLIC route (not inside `(app)` route group). No auth check needed -- the share_token RLS policy handles access control.

5. **Section dividers:** Use `<section>` elements with `space-y-6` for each report section. Add section headings (text-xl font-semibold text-text-primary) where appropriate.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Report page is at `src/app/report/[token]/page.tsx` (NOT inside `(app)` group)
4. Page loads data server-side via share_token query
5. Page calls notFound() for missing/incomplete reports
6. Page renders ReportHeader, RecommendationCard, and RankedTable
7. ShareButton copies URL to clipboard on click
  </verify>
  <done>Report page loads data server-side via share_token, renders header with share button, ready for remaining components.</done>
</task>

<task type="auto">
  <name>Task 2: Recommendation card and sortable ranked table</name>
  <files>
    src/components/report/recommendation-card.tsx
    src/components/report/ranked-table.tsx
  </files>
  <action>
**Step A: Create `src/components/report/recommendation-card.tsx`** (server component, no "use client"):

- Props: `recommended: ModelSummary | undefined`, `rationale: string`, `models: ModelSummary[]`
- If no recommended model, render nothing (return null)
- Render a prominent card:
  - Trophy icon (lucide-react) in ember color
  - "Top Recommendation" label in text-sm text-text-muted uppercase tracking-wide
  - Model name in text-2xl font-bold text-text-primary
  - Provider and tier badge next to name (e.g., "google | premium" in small text-text-muted)
  - Rationale text in text-text-secondary
  - Key metrics in a 4-column grid:
    - Accuracy: {accuracy}% with label
    - Cost: ${costPerRun}/call with label
    - Median latency: {medianLatency}ms with label
    - Consistency: ±{spread}% with label
  - Savings callout: if recommended model is cheaper than the most expensive tested model and savings > 10%, show "Save {X}% vs {expensive model name}" in a green-tinted badge
- Styling: `bg-surface-raised border border-ember/30 rounded-xl p-6` for the ember-tinted recommendation look

**Step B: Create `src/components/report/ranked-table.tsx`** (`"use client"` component):

- Props: `models: ModelSummary[]`
- State: `sortKey` (default "accuracy"), `sortDesc` (default true)
- Sort keys type: `"accuracy" | "costPerRun" | "medianLatency" | "p95Latency" | "spread" | "exactMatchRate"`

**Sort logic:**
- `useMemo` with sorted copy of models array
- On column header click: if same key, toggle direction; if different key, set key and choose default direction (desc for accuracy/exactMatchRate, asc for cost/latency/spread)
- Sort using simple `a[sortKey] - b[sortKey]` comparison

**Table columns:**
| Column | Key | Align | Format |
|--------|-----|-------|--------|
| Rank | (index) | center | #1, #2, ... |
| Model | (name) | left | Name + provider badge |
| Accuracy | accuracy | right | 98.5% |
| Exact Match | exactMatchRate | right | 85% |
| Cost/Run | costPerRun | right | $0.0042 (4-6 decimal places) |
| Median RT | medianLatency | right | 1,234ms |
| P95 RT | p95Latency | right | 2,456ms |
| Spread | spread | right | ±3.2% |
| Runs | (completed/attempted) | center | 30/30 |

**Styling:**
- Table: `w-full text-sm` with `overflow-x-auto` wrapper for mobile
- Header row: `border-b border-surface-border text-text-muted font-medium`
- Sortable columns: `cursor-pointer hover:text-text-primary` with sort indicator arrow (ArrowUpDown from lucide-react, or simple "^" / "v" text)
- Active sort column: text-ember
- Data rows: `border-b border-surface-border/50 hover:bg-surface-raised/50`
- Rank column: bold for #1, ember color for #1
- Numbers: `tabular-nums font-mono` for alignment
- Use `toLocaleString()` for number formatting with commas

**Top row highlight:** #1 ranked model row gets subtle ember background: `bg-ember/5`
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. RecommendationCard renders trophy icon, model name, rationale, metrics grid, and savings badge
3. RankedTable renders all 9 columns with correct formatting
4. Clicking column headers sorts the table (toggles asc/desc)
5. Sort state managed via useState, sorted data via useMemo
6. Table has responsive overflow wrapper for mobile
  </verify>
  <done>Recommendation card shows top model with rationale and savings. Ranked table is sortable by all metric columns. Fulfills RPT-01 and RPT-02.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Report page accessible at /report/[token] route
4. Report shows recommendation card for top model
5. Report shows sortable ranked table with all metric columns
6. Share button copies link to clipboard
7. Invalid/missing tokens return 404
</verification>

<success_criteria>
- Report page loads all data server-side via share_token (no auth required)
- 404 returned for invalid tokens or non-complete reports
- Recommendation card displays model name, rationale, key metrics, and savings callout
- Ranked table sortable by accuracy, cost, median RT, P95 RT, spread, and exact match rate
- Share button copies shareable URL to clipboard
- Page structure includes id="report-content" for PDF export targeting
- All components use existing Tailwind dark-warm palette
</success_criteria>

<output>
After completion, create `.planning/phases/03-results-and-report/03-03-SUMMARY.md`
</output>
