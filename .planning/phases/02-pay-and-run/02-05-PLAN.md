---
phase: 02-pay-and-run
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/debug/mock-config.ts
  - src/lib/debug/mock-provider.tsx
  - src/components/debug/mock-indicator.tsx
  - src/components/wizard/confirmation-screen.tsx
  - src/app/layout.tsx
  - .env.local.example
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Mock indicator badge shows all active mocks derived from DEBUG_MOCK_* env vars without NEXT_PUBLIC_DEBUG_MOCKS"
    - "Confirmation screen mock payment detection derives from DEBUG_MOCK_STRIPE without NEXT_PUBLIC_DEBUG_MOCKS"
    - "NEXT_PUBLIC_DEBUG_MOCKS env var no longer exists in env files or code"
  artifacts:
    - path: "src/lib/debug/mock-provider.tsx"
      provides: "MockProvider context component and useMocks() hook for client components"
      exports: ["MockProvider", "useMocks"]
    - path: "src/lib/debug/mock-config.ts"
      provides: "Server-side mock detection (getClientActiveMocks removed)"
    - path: "src/components/debug/mock-indicator.tsx"
      provides: "Badge reads mocks from context, not env var"
      contains: "useMocks"
    - path: "src/components/wizard/confirmation-screen.tsx"
      provides: "Mock stripe detection reads from context"
      contains: "useMocks"
    - path: "src/app/layout.tsx"
      provides: "MockProvider wrapping children with server-read mock state"
      contains: "MockProvider"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/lib/debug/mock-config.ts"
      via: "getActiveMocks() called server-side, result passed to MockProvider"
      pattern: "getActiveMocks"
    - from: "src/lib/debug/mock-provider.tsx"
      to: "src/components/debug/mock-indicator.tsx"
      via: "useMocks() hook consumed by MockIndicator"
      pattern: "useMocks"
    - from: "src/lib/debug/mock-provider.tsx"
      to: "src/components/wizard/confirmation-screen.tsx"
      via: "useMocks() hook consumed for isMockStripe check"
      pattern: "useMocks"
---

<objective>
Replace the redundant NEXT_PUBLIC_DEBUG_MOCKS env var with a server-to-client MockProvider context that derives mock state from the existing DEBUG_MOCK_* env vars.

Purpose: UAT Test 5 reports confusion from having NEXT_PUBLIC_DEBUG_MOCKS duplicating the three individual DEBUG_MOCK_* vars. They are already out of sync in .env.local (only shows "stripe" when all 3 mocks are active). The fix uses a React context provider populated from server-side getActiveMocks() to deliver mock state to client components.
Output: Single source of truth for mock configuration with no manual sync required.
</objective>

<execution_context>
@/Users/lukelibraro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lukelibraro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-pay-and-run/02-01-SUMMARY.md
@.planning/debug/02-mock-indicator-env.md

Key source files:
@src/lib/debug/mock-config.ts
@src/components/debug/mock-indicator.tsx
@src/components/wizard/confirmation-screen.tsx
@src/app/layout.tsx
@.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MockProvider context and update all consumers</name>
  <files>src/lib/debug/mock-config.ts, src/lib/debug/mock-provider.tsx, src/components/debug/mock-indicator.tsx, src/components/wizard/confirmation-screen.tsx, src/app/layout.tsx, .env.local.example</files>
  <action>
**FILE 1: `src/lib/debug/mock-config.ts`**

Keep the existing server-side functions (`isMockStripe`, `isMockOpenRouter`, `isMockEmail`, `getActiveMocks`) unchanged -- they are used by server-side code (checkout route, webhook, engine).

REMOVE `getClientActiveMocks()` function entirely (lines 35-39) -- this is the function that reads the redundant NEXT_PUBLIC_DEBUG_MOCKS. Also remove its JSDoc comment (lines 30-34).

**FILE 2: `src/lib/debug/mock-provider.tsx` (NEW FILE)**

Create a new client component file for the React context provider:

```typescript
"use client";

import { createContext, useContext } from "react";

interface MockContextValue {
  mocks: string[];
}

const MockContext = createContext<MockContextValue>({ mocks: [] });

export function MockProvider({
  mocks,
  children,
}: {
  mocks: string[];
  children: React.ReactNode;
}) {
  return (
    <MockContext.Provider value={{ mocks }}>
      {children}
    </MockContext.Provider>
  );
}

/** Hook to read active mocks in client components */
export function useMocks(): string[] {
  return useContext(MockContext).mocks;
}
```

This file is separate from mock-config.ts because it needs "use client" while mock-config.ts is used server-side (no directive).

**FILE 3: `src/components/debug/mock-indicator.tsx`**

Replace `getClientActiveMocks()` with `useMocks()` hook. Replace the import:
- Remove: `import { getClientActiveMocks } from "@/lib/debug/mock-config"`
- Add: `import { useMocks } from "@/lib/debug/mock-provider"`

Replace `const mocks = getClientActiveMocks()` with `const mocks = useMocks()`. Keep everything else the same.

**FILE 4: `src/components/wizard/confirmation-screen.tsx`**

Replace `getClientActiveMocks().includes("stripe")` with `useMocks()`:
- Remove: `import { getClientActiveMocks } from "@/lib/debug/mock-config"`
- Add: `import { useMocks } from "@/lib/debug/mock-provider"`
- Change line 31 from `const isMock = getClientActiveMocks().includes("stripe")` to:
  ```typescript
  const mocks = useMocks();
  const isMock = mocks.includes("stripe");
  ```

**FILE 5: `src/app/layout.tsx`**

This is a Server Component. Add imports and wrap children with MockProvider:

Add imports:
```typescript
import { getActiveMocks } from "@/lib/debug/mock-config";
import { MockProvider } from "@/lib/debug/mock-provider";
```

Keep existing MockIndicator import.

Update the body content from:
```tsx
<NuqsAdapter>{children}</NuqsAdapter>
<MockIndicator />
```

To:
```tsx
<MockProvider mocks={getActiveMocks()}>
  <NuqsAdapter>{children}</NuqsAdapter>
  <MockIndicator />
</MockProvider>
```

**FILE 6: `.env.local.example`**

Remove the `NEXT_PUBLIC_DEBUG_MOCKS=` line entirely. Update the comment:

Change:
```
# Debug mocks (set to 'true' to enable)
DEBUG_MOCK_STRIPE=false
DEBUG_MOCK_OPENROUTER=false
DEBUG_MOCK_EMAIL=false
NEXT_PUBLIC_DEBUG_MOCKS=
```

To:
```
# Debug mocks (set to 'true' to enable; automatically detected by UI badge)
DEBUG_MOCK_STRIPE=false
DEBUG_MOCK_OPENROUTER=false
DEBUG_MOCK_EMAIL=false
```

**FILE 7: `.env.local` (if it exists)** -- delete the NEXT_PUBLIC_DEBUG_MOCKS line from the actual .env.local file. Read .env.local first; if it has NEXT_PUBLIC_DEBUG_MOCKS, remove that line.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (no type errors)
2. `npm run build` succeeds
3. Grep confirms: No references to `NEXT_PUBLIC_DEBUG_MOCKS` in any source file or .env.local.example
4. Grep confirms: No references to `getClientActiveMocks` in any source file
5. Grep confirms: `useMocks` is imported in mock-indicator.tsx and confirmation-screen.tsx
6. Grep confirms: `MockProvider` is used in layout.tsx with `getActiveMocks()` call
  </verify>
  <done>
Mock indicator badge and confirmation screen both derive mock state from DEBUG_MOCK_* server-side env vars via MockProvider context. NEXT_PUBLIC_DEBUG_MOCKS env var removed from code and env files. No manual sync required.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. `npm run build` passes
2. `npm test` -- all existing 50 tests pass
3. No references to NEXT_PUBLIC_DEBUG_MOCKS anywhere in codebase
4. MockProvider renders in layout.tsx with server-derived mock list
5. MockIndicator and ConfirmationScreen consume useMocks() hook
</verification>

<success_criteria>
- Mock indicator badge shows correct list of active mocks based on DEBUG_MOCK_* env vars
- Setting DEBUG_MOCK_STRIPE=true, DEBUG_MOCK_OPENROUTER=true, DEBUG_MOCK_EMAIL=true shows all three in badge
- Confirmation screen mock detection works via context (not separate env var)
- NEXT_PUBLIC_DEBUG_MOCKS completely removed from codebase
- `npm run build` passes
- All existing tests pass (`npm test`)
</success_criteria>

<output>
After completion, create `.planning/phases/02-pay-and-run/02-05-SUMMARY.md`
</output>
